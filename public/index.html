<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE PCR Tracker - Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .symbol {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .price {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .pcr-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            margin: 20px 0;
        }

        .pcr-label {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .pcr-value {
            color: white;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .sentiment {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .sentiment.bullish { background: #d4edda; color: #155724; }
        .sentiment.bearish { background: #f8d7da; color: #721c24; }
        .sentiment.neutral { background: #fff3cd; color: #856404; }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .metric {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 50px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .pcr-value {
                font-size: 2rem;
            }
        }

        .refresh-info {
            color: white;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š NSE PCR Tracker</h1>
            <div class="status">
                <span id="market-status">Checking market status...</span>
            </div>
            <div class="refresh-info">
                <span id="last-update">Loading...</span>
            </div>
        </div>

        <div id="loading" class="loading pulse">
            Loading live data...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" class="dashboard" style="display: none;">
            <!-- NIFTY Card -->
            <div class="card">
                <div class="card-header">
                    <div class="symbol">NIFTY</div>
                    <div class="price" id="nifty-price">â‚¹--,---</div>
                </div>
                
                <div class="pcr-display">
                    <div class="pcr-label">PUT-CALL RATIO</div>
                    <div class="pcr-value" id="nifty-pcr">--</div>
                    <div>
                        <span class="sentiment" id="nifty-sentiment">--</span>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Call OI</div>
                        <div class="metric-value" id="nifty-call-oi">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Put OI</div>
                        <div class="metric-value" id="nifty-put-oi">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Call Change</div>
                        <div class="metric-value" id="nifty-call-change">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Put Change</div>
                        <div class="metric-value" id="nifty-put-change">--</div>
                    </div>
                </div>
            </div>

            <!-- BANKNIFTY Card -->
            <div class="card">
                <div class="card-header">
                    <div class="symbol">BANKNIFTY</div>
                    <div class="price" id="banknifty-price">â‚¹--,---</div>
                </div>
                
                <div class="pcr-display">
                    <div class="pcr-label">PUT-CALL RATIO</div>
                    <div class="pcr-value" id="banknifty-pcr">--</div>
                    <div>
                        <span class="sentiment" id="banknifty-sentiment">--</span>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Call OI</div>
                        <div class="metric-value" id="banknifty-call-oi">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Put OI</div>
                        <div class="metric-value" id="banknifty-put-oi">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Call Change</div>
                        <div class="metric-value" id="banknifty-call-change">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Put Change</div>
                        <div class="metric-value" id="banknifty-put-change">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ðŸš€ Powered by NSE PCR Cloud Tracker</p>
            <p style="font-size: 0.85rem; margin-top: 10px; opacity: 0.8;">
                Auto-refreshes every 30 seconds | Market Hours: 9:15 AM - 3:30 PM IST
            </p>
        </div>
    </div>

    <script>
        const API_BASE = '';  // Same server

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(Math.round(num));
        }

        function formatPrice(num) {
            return 'â‚¹' + new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function getSentimentClass(sentiment) {
            if (sentiment.includes('Bullish')) return 'bullish';
            if (sentiment.includes('Bearish')) return 'bearish';
            return 'neutral';
        }

        function updateCard(symbol, data) {
            const prefix = symbol.toLowerCase();
            
            document.getElementById(`${prefix}-price`).textContent = formatPrice(data.price);
            document.getElementById(`${prefix}-pcr`).textContent = data.pcr.toFixed(2);
            document.getElementById(`${prefix}-call-oi`).textContent = formatNumber(data.callOI);
            document.getElementById(`${prefix}-put-oi`).textContent = formatNumber(data.putOI);
            document.getElementById(`${prefix}-call-change`).textContent = formatNumber(data.callChange);
            document.getElementById(`${prefix}-put-change`).textContent = formatNumber(data.putChange);
            
            const sentimentEl = document.getElementById(`${prefix}-sentiment`);
            sentimentEl.textContent = data.sentiment;
            sentimentEl.className = 'sentiment ' + getSentimentClass(data.sentiment);
        }

        async function fetchData() {
            try {
                const niftyRes = await fetch(`${API_BASE}/api/pcr/NIFTY`);
                const niftyData = await niftyRes.json();
                
                const bankniftyRes = await fetch(`${API_BASE}/api/pcr/BANKNIFTY`);
                const bankniftyData = await bankniftyRes.json();
                
                if (niftyData.success && bankniftyData.success) {
                    updateCard('nifty', {
                        price: niftyData.underlyingValue,
                        pcr: niftyData.pcr,
                        callOI: niftyData.totalCallOI,
                        putOI: niftyData.totalPutOI,
                        callChange: niftyData.callOIChange,
                        putChange: niftyData.putOIChange,
                        sentiment: getSentiment(niftyData.pcr)
                    });
                    
                    updateCard('banknifty', {
                        price: bankniftyData.underlyingValue,
                        pcr: bankniftyData.pcr,
                        callOI: bankniftyData.totalCallOI,
                        putOI: bankniftyData.totalPutOI,
                        callChange: bankniftyData.callOIChange,
                        putChange: bankniftyData.putOIChange,
                        sentiment: getSentiment(bankniftyData.pcr)
                    });
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'grid';
                    document.getElementById('error').style.display = 'none';
                    
                    const now = new Date().toLocaleTimeString('en-IN');
                    document.getElementById('last-update').textContent = `Last updated: ${now}`;
                }
            } catch (error) {
                document.getElementById('error').textContent = 'Error loading data. Retrying...';
                document.getElementById('error').style.display = 'block';
            }
        }

        function getSentiment(pcr) {
            if (pcr >= 1.25) return 'Strong Bullish';
            if (pcr >= 1.10) return 'Bullish';
            if (pcr >= 1.00) return 'Neutral-Bullish';
            if (pcr >= 0.85) return 'Neutral';
            if (pcr >= 0.75) return 'Neutral-Bearish';
            if (pcr >= 0.60) return 'Bearish';
            return 'Strong Bearish';
        }

        async function checkMarketStatus() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                const statusEl = document.getElementById('market-status');
                statusEl.textContent = data.marketOpen ? 'ðŸŸ¢ Market OPEN' : 'ðŸ”´ Market CLOSED';
            } catch (error) {
                console.error('Status check failed');
            }
        }

        // Initial load
        fetchData();
        checkMarketStatus();

        // Auto-refresh every 30 seconds
        setInterval(fetchData, 30000);
        setInterval(checkMarketStatus, 60000);
    </script>
</body>
</html>
